# åŸºäºæ•°æ®æµçš„è¶Šæƒæ£€æµ‹

> éšç€æŠ€æœ¯çš„å‘å±•å’Œå®‰å…¨æŠ€æœ¯çš„æ™®åŠï¼Œåœ¨å¤§éƒ¨åˆ†äº’è”ç½‘ä¼ä¸šwebå®‰å…¨æ¼æ´å¯èƒ½å‡ºç°åœ¨ä¸šåŠ¡é€»è¾‘ä¸Šçš„æ¼æ´æ¯”è¾ƒçªå‡ºï¼Œå°¤å…¶æ˜¯è¶Šæƒé—®é¢˜ï¼Œé»‘ç›’æµ‹è¯•ä¼šå¸¦æ¥å¤§é‡è„æ•°æ®ï¼ŒåŒæ—¶ç™½ç›’æ‰«æè®©äººæ— æ³•æ¥å—çš„è¯¯æŠ¥ç‡ã€ä»£ç å®¡è®¡çš„ä½æ•ˆç‡éƒ½æ˜¯æŒ–æ˜è¶Šæƒæ¼æ´çš„å¤§å±±ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½æœ‰æ›´å¥½çš„æ€è·¯è§£å†³è¿™äº›é—®é¢˜æ˜¯æˆ‘ä¸€ç›´åœ¨æ€è€ƒçš„ä¸€ä¸ªé—®é¢˜ã€‚

## 0x1 æ‰¾åˆ°é—®é¢˜

>éšç€ç ”å‘-æµ‹è¯•æµç¨‹çš„å®Œå–„ï¼Œå¤§éƒ¨åˆ†æµ‹è¯•éƒ¨é—¨çš„åŒå­¦ä¼šåœ¨æ–°çš„ä»£ç éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒä»¥åä¼šè¿›è¡ŒåŠŸèƒ½æµ‹è¯•ï¼Œåœ¨è¿›è¡ŒåŠŸèƒ½æµ‹è¯•çš„åŒæ—¶å®‰å…¨åŒå­¦å¯ä»¥é€šè¿‡æŠ“å–æµé‡ï¼Œç„¶åé€šè¿‡å¯¹æµé‡è¿›è¡Œå›æ”¾å®ç°éƒ¨åˆ†æ¼æ´çš„æ£€æµ‹ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸å¯¹getç±»å‹çš„è¯·æ±‚åšsqlæ³¨å…¥æ£€æµ‹ï¼Œè¿˜å¯ä»¥é€šè¿‡æ›¿æ¢èº«ä»½ä¿¡æ¯è¿›è¡Œæ™®é€šçš„æœªæˆæƒã€è¶Šæƒæ£€æµ‹ï¼Œé€šè¿‡ä»¥ä¸Šæˆ‘ä»¬åº”è¯¥ä¹Ÿå¯ä»¥å‘ç°ä¸€äº›é—®é¢˜ï¼Œé‚£ä¹ˆå®é™…ç”Ÿäº§ä¸­å­˜åœ¨å¤§é‡çš„éœ€è¦å’Œæ•°æ®åº“è¿›è¡Œäº¤äº’çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¿®æ”¹ä¸ªäººä¿¡æ¯ã€ä¿®æ”¹æ”¶è´§åœ°å€ã€æ·»åŠ æ”¶è´§åœ°å€ã€åˆ é™¤æ”¶è·åœ°å€ç±»ä¼¼çš„åœºæ™¯ï¼Œé’ˆå¯¹è¿™äº›ç±»å‹çš„è¶Šæƒæ£€æµ‹å¤§éƒ¨åˆ†å®‰å…¨åŒå­¦å¯èƒ½æ˜¯ç”³è¯·ä¸¤ä¸ªè´¦å·ç„¶åè¿›è¡Œæµ‹è¯•ï¼Œç„¶åé€šè¿‡æ¯”å¯¹è¿”å›çš„ç»“æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¶Šæƒï¼Œä»¥ä¸Šä¹Ÿå¯ä»¥å®ç°è‡ªåŠ¨åŒ–æ£€æµ‹ï¼Œæ— éæ˜¯æ›¿æ¢èº«ä»½è®¤è¯å­—æ®µé‡æ”¾è¯·æ±‚ï¼Œä½†æ˜¯ä»¥ä¸Šæ£€æµ‹æ–¹æ³•ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å¯èƒ½ä¼šå¸¦æ¥å¤§é‡è„æ•°æ®ç„¶åå¯¹qaçš„æµ‹è¯•ä¼šäº§ç”Ÿä¸€å®šçš„å½±å“ï¼Œæƒ³æƒ³ä»¥å‰é’ˆå¯¹postç±»å‹çš„æ³¨å…¥æ˜¯ä¸æ˜¯åŠ è¿‡ **or 1=1**ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ–¹æ³•è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Œä¸‹é¢å°±æ˜¯æˆ‘çš„ä¸€äº›æ€è€ƒ

## 0x2 å¦‚ä½•åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¼æ´

> é¦–å…ˆæ€è€ƒä¸‹æˆ‘ä»¬åœ¨æ—¥å¸¸æŒ–æ´çš„æ—¶å€™æ˜¯å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ¥å£æ˜¯å¦å­˜åœ¨å®‰å…¨é—®é¢˜çš„

å…ˆæ‹¿postç±»å‹çš„sqlæ³¨å…¥æ¥è®²ï¼Œå‡å¦‚å­˜åœ¨ä¸€ä¸ªåœºæ™¯æ˜¯ä¿®æ”¹è‡ªå·±çš„addressï¼Œæˆ‘ä»¬æˆªè·çš„è¯·æ±‚å¦‚ä¸‹

```
POST /rest/parentrest/api/pc/address/update HTTP/1.1
Host: 127.0.0.1:8001
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: image/webp,*/*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: keep-alive
Cookie: SESSION=SSSIONFORSARA;

username=sara&address=china+beijing
```

å‡è®¾å¯ä»¥æ‹¦æˆªåˆ°æ‰§è¡Œçš„sqlï¼Œé‚£ä¹ˆsqlè¯­å¥åº”è¯¥å¦‚ä¸‹

>UPDATE users SET address = "china+beijing" WHERE username = "sara" 

é‚£ä¹ˆæˆ‘ä»¬è¦åˆ¤æ–­usernameå­—æ®µæ˜¯å¦å­˜åœ¨æ³¨å…¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹username=sara"+and+"1

```
POST /rest/parentrest/api/pc/address/update HTTP/1.1
Host: 127.0.0.1:8001
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: image/webp,*/*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: keep-alive
Cookie: SESSION=SSSIONFORSARA;


username=sara"+and+"1&address=china+beijing
```
å‡è®¾åç«¯å­˜åœ¨sqlæ‹¼æ¥ï¼Œé‚£ä¹ˆsqlè¯­å¥å¯èƒ½æ˜¯è¿™æ ·å­çš„
>UPDATE users SET address = "china+beijing" WHERE username = "sara" and "1" 

å¾ˆæ˜æ˜¾è¿™æ ·å°±æ‹¼æ¥æˆäº†ä¸€æ¡å¯ä»¥æ‰§è¡Œçš„sqlè¯­å¥ï¼Œç„¶åä¼šæäº¤ç»™æ•°æ®åº“å»æ‰§è¡Œäº†
é€šè¿‡ä»¥ä¸Šåˆ†æå¯¹ä»¥ä¸Šçš„ç®€å•æ¡ˆä¾‹å…¶å®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªè¦æ‹¿åˆ°æ‰§è¡Œçš„sqlè¯­å¥åŸºæœ¬å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ³¨å…¥äº†ï¼Œè€Œæ— éœ€è®©sqlç»§ç»­å»æäº¤ç»™æ•°æ®åº“å¼•æ“å»æ‰§è¡Œï¼Œåœ¨åšå®‰å…¨è¯„ä¼°æ—¶ç»å¸¸ä¼šé‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ‹…å¿ƒäº§ç”Ÿè„æ•°æ®ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚å¼€å‘åŒå­¦å¯¹usernameåšäº†è¿‡æ»¤ï¼Œå‡è®¾åªç•™äº†or "1å¯ä»¥æäº¤é€šè¿‡ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬è¿›è¡Œæµ‹è¯•çš„æ—¶å€™å°±æœ‰é£é™©æŠŠå…¶ä»–äººçš„ä¿¡æ¯å…¨éƒ¨æ”¹æ‰ï¼Œç›¸ä¿¡èº«è¾¹äººæœ‰é‡åˆ°è¿‡é€šè¿‡åŠ  or 1=1æŠŠè¡¨ä¸­å…¨éƒ¨ä¿¡æ¯éƒ½æ”¹æ‰çš„å…‰è¾‰å†å²ï¼Œé‚£ä¹ˆå‡å¦‚æˆ‘ä»¬å¯ä»¥è·å–åˆ°æäº¤è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠè¿™äº›è¯·æ±‚å¸¦æ¥äº†å“ªäº›æ•°æ®äº¤äº’ä¹Ÿå°±æ˜¯æ‰§è¡Œäº†å“ªäº›sqlè¯­å¥ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…å‘¢ï¼Ÿæ¯”å¦‚ï¼š

* ä½¿ç”¨åŸèº«ä»½æ›¿æ¢usernameçš„å€¼ä¸º username=sara" and "iastï¼Œåˆ¤æ–­æ‹¦æˆªçš„sqlè¯­å¥æ˜¯å¦å­˜åœ¨æ‹¼æ¥
* æ›¿æ¢èº«ä»½è¿›è¡Œé‡æ”¾,è®°å½•/æ‹¦æˆªupdateçš„sqlè¯­å¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¶Šæƒ
* æ‹¦æˆªæ‰«æå™¨è¯·æ±‚å¸¦æ¥çš„updateç±»å‹sqlè¯­å¥

ä»Šå¤©é‡ç‚¹åˆ†æè¶Šæƒæ£€æµ‹æ‰€ä»¥æˆ‘ä»¬ç»§ç»­æ‹¿è¶Šæƒæ¼æ´åšä¾‹å­è®²
å‡å¦‚æˆ‘ä»¬æ›¿æ¢äº†èº«ä»½è®¤è¯å­—æ®µ 

**Cookie ï¼šSESSION=SSSIONFORBOB**

```
POST /rest/parentrest/api/pc/address/update HTTP/1.1
Host: 127.0.0.1:8001
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: image/webp,*/*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: keep-alive
Cookie: SESSION=SSSIONFORBOB;


username=sara&address=china+beijing
```

å‡è®¾ä¸å­˜åœ¨è¶Šæƒé‚£ä¹ˆå¼€å‘åŒå­¦åº”è¯¥ä¼šé€šè¿‡sessionä¸­è·å–ç”¨æˆ·çš„ä¿¡æ¯æ ‡ç¤ºä½œä¸ºæ¡ä»¶æ‰§è¡Œupdateï¼Œæ¯”å¦‚ä»sessionä¸­è·å–ç”¨æˆ·id

>UPDATE users SET address = "china+beijing" WHERE id = 12

å‡è®¾å­˜åœ¨è¶Šæƒé‚£ä¹ˆwhereæ¡ä»¶ä¸­çš„ä¿¡æ¯åº”è¯¥æ¥è‡ªæˆ‘ä»¬æäº¤çš„å‚æ•°username
 
>UPDATE users SET address = "china+beijing" WHERE username="sara"

é€šè¿‡æ¯”å¯¹æ›¿æ¢èº«ä»½è®¤è¯ä»¥åæ‰§è¡Œçš„sqlè¯­å¥å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¶Šæƒï¼Œ


## 0x3 æŠ€æœ¯å®ç°

å¤§ä½“æ€è·¯å…ˆæ¢³ç†ä¸‹
![](./images/14.png)

æŠ€æœ¯ä¸Šä¸»è¦è§£å†³ä¸€ä¸‹å‡ ä¸ªé—®é¢˜

* æµé‡å¤„ç†ï¼ˆè·å–ã€æ¸…æ´—ã€å»é‡ï¼‰
* è¯·æ±‚æ ‡è®°ã€é‡æ”¾
* åˆ¤æ–­sqlæ˜¯å¦ä¸€è‡´
* æ‹¦æˆªupdateç±»å‹sqlè¯­å¥

### 0x301 æ•°æ®æµä¿¡æ¯å¤„ç†

> è¿™é‡Œçš„æ•°æ®æµä¿¡æ¯ä¸ä»…åŒ…æ‹¬httpè¯·æ±‚çš„æµé‡ï¼Œè¿˜åŒ…æ‹¬æ‰§è¡Œçš„sqlè¯­å¥ã€sqlæ‰§è¡Œå®Œè¿”å›çš„å¯¹è±¡ä¿¡æ¯ï¼Œä¸ºäº†èƒ½å¤Ÿæ ‡ç¤ºæˆ‘ä»¬å‘èµ·çš„è¯·æ±‚å¯¹åº”æ‰§è¡Œäº†å“ªäº›sqlï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯·æ±‚ä¸­æ·»åŠ è‡ªå®šä¹‰çš„æ ‡ç¤ºæ¯”å¦‚requestIDï¼Œæ‰€æœ‰çš„httpä¿¡æ¯ã€sqlè¯­å¥ä¿¡æ¯ã€sqlæ‰§è¡Œå®Œè¿”å›çš„å¯¹è±¡ä¿¡æ¯éƒ½å¯ä»¥é€šè¿‡requestIdè¿›è¡Œå­˜å‚¨å’ŒæŸ¥è¯¢

ä¸‹é¢ç®€å•è¯´ä¸‹å„ç§ä¿¡æ¯è¯¥å¦‚ä½•è·å–ä»¥åŠå¤„ç†æ€è·¯

#### httpä¿¡æ¯
httpè¯·æ±‚çš„ä¿¡æ¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯¹httpè¯·æ±‚çš„ä¿¡æ¯è¿›è¡Œäº†æ‹†åˆ†å­˜å‚¨

* headers     
* url
* method
* body
* parameters
 

#### sqlè¯­å¥å¤„ç†

sqlçš„å¤„ç†ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ç‚¹

* è®°å½•
* åˆ¤æ–­å‰åä¸¤ä¸ªè¯·æ±‚sqlè¯­å¥æ˜¯å¦ç›¸åŒ
* æ‹¦æˆªupdateç±»å‹sqlè¯­å¥é˜²æ­¢äº§ç”Ÿè„æ•°æ®

æˆ‘ä»¬æ‹¿ mysql-connector-java-8.0.13.jar ä¸¾ä¾‹ï¼Œåœ¨ **com.mysql.cj.NativeSession** ç±»ä¸­çš„ **execsql** æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°å‚æ•°æœ‰ä¸€ä¸ª **packet**ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬å‘é€ç»™ **mysql** çš„æ‰§è¡Œçš„ **sql** è¯­å¥æ•°æ®ï¼Œç„¶åçœ‹äº†ä¸‹ **NativePacketPayload** ç±»å‘ç°å¯ä»¥é€šè¿‡**packet.setByteBuffer( byte[] bytes)** æ–¹æ³•ä¿®æ”¹ **packet** çš„å€¼ï¼Œæ­¤æ—¶æ£€æµ‹åˆ°æ‰«æå™¨å‘èµ·çš„è¯·æ±‚å¦‚æœåŒ…å« **update** ç±»å‹çš„ **sql** è¯­å¥åˆ™å¯ä»¥å¯¹ **packet** è¿›è¡Œç¯¡æ”¹ã€‚

> com.mysql.cj.NativeSession.java ä¸­ execSQLæ–¹æ³•å¯¹åº”çš„éƒ¨åˆ†ä»£ç 

```
public <T extends Resultset> T execSQL(Query callingQuery, String query, int maxRows, NativePacketPayload packet, boolean streamResults,
            ProtocolEntityFactory<T, NativePacketPayload> resultSetFactory, String catalog, ColumnDefinition cachedMetadata, boolean isBatch) {
            
        //å¯ä»¥åœ¨æ­¤å¤„é€šè¿‡æ’æ¡©æ’å…¥æ£€æµ‹çš„ä»£ç 

        long queryStartTime = 0;
        int endOfQueryPacketPosition = 0;
        if (packet != null) {
            endOfQueryPacketPosition = packet.getPosition();
        }

        if (this.gatherPerfMetrics.getValue()) {
            queryStartTime = System.currentTimeMillis();
        }

        this.lastQueryFinishedTime = 0; // we're busy!

        if (this.autoReconnect.getValue() && (getServerSession().isAutoCommit() || this.autoReconnectForPools.getValue()) && this.needsPing && !isBatch) {
            try {
                ping(false, 0);
                this.needsPing = false;

            } catch (Exception Ex) {
                invokeReconnectListeners();
            }
        }
...
```

åœ¨openraspä¸­å¯ä»¥ç¼–å†™è‡ªå®šä¹‰çš„ç¼–ç è½¬æ¢å™¨SqlTransformer2ç±»æ’å…¥åˆ°EngineBootç±»çš„initTransformeræ–¹æ³•ä¸­ï¼Œå¯ä»¥å®ç°å°† **requestId** å’Œ **sql** è¯­å¥ä¸€èµ·å­˜å‚¨åˆ°redisä¸­ï¼Œå½“ç„¶è¿˜éœ€è¦å„ä½è‡ªå·±å†™ä¸‹com.baidu.openrasp.hook.InsertRedis.InsertInfoToRedis()ç±»ç”¨äºå¾€ **redis** ä¸­å†™å…¥æ•°æ®


> SqlTransformer2.java

```
package com.baidu.openrasp.hook.molice;

import javassist.*;

import java.lang.instrument.ClassFileTransformer;
import java.security.ProtectionDomain;


/**
 * Description
 * <p>
 * </p>
 * DATE 2020/4/5.
 *
 * @author molice.
 */
public class SqlTransformer2 implements ClassFileTransformer {
    /*
     * è®°å½•/æ‹¦æˆªæ‰§è¡Œçš„updateè¯­å¥
     * todo æ ¹æ®requestIdåˆ¤æ–­è¯·æ±‚æ˜¯å¦æ¥è‡ªæ‰«æå™¨
     * todo å¦‚æœä¸æ˜¯æ¥è‡ªæ‰«æå™¨åˆ™è®°å½•æ‰§è¡Œçš„sqlè¯­å¥ï¼Œå¹¶å¯¹è¿”å›ç»“æœè¿›è¡Œåºåˆ—åŒ–æ“ä½œ
     * todo å¦‚æœåˆ¤æ–­æ˜¯æ¥è‡ªæ‰«æå™¨ï¼Œåˆ™è®°å½•sqlè¯­å¥å¹¶å¯¹å­˜å‚¨çš„åŸå§‹æ•°æ®è¿›è¡Œååºåˆ—åŒ–å¹¶è¿”å›è¯¥å¯¹è±¡ï¼Œä¿è¯åœ¨ä¸å’Œæ•°æ®åº“è¿›è¡Œäº¤äº’çš„å‰æä¸‹å®Œæˆä¸šåŠ¡æµç¨‹
     *
     * */

    @Override
    public byte[] transform(final ClassLoader loader, final String className, final Class <?> classBeingRedefined, final ProtectionDomain protectionDomain, final byte[] classfileBuffer) {
//        if ("com/mysql/cj/jdbc/ClientPreparedStatement".equals( className )) {

        if ("com/mysql/cj/NativeSession".equals( className )) {
            try {
                //1ã€æ‰€å¼•ç”¨çš„ç±»å‹ï¼Œå¿…é¡»é€šè¿‡ClassPoolè·å–åæ‰å¯ä»¥ä½¿ç”¨
                //2ã€ä»£ç å—ä¸­æ‰€ç”¨åˆ°çš„å¼•ç”¨ç±»å‹ï¼Œä½¿ç”¨æ—¶å¿…é¡»å†™å…¨é‡ç±»å
                final CtClass clazz = ClassPool.getDefault().get( className.replace( "/", "." ) );
                System.out.println( "className is :" + clazz.getName() );
                CtMethod executeUpdateInternal = clazz.getDeclaredMethod( "execSQL" );
                executeUpdateInternal.insertBefore( "" +
                                "com.baidu.openrasp.request.AbstractRequest request = com.baidu.openrasp.HookHandler.requestCache.get();" +
                                "com.mysql.cj.protocol.a.NativePacketPayload pack = $4;" +
                                "String currentSql = String.valueOf(pack);" +
                                "if (pack != null){String resultStr = (new com.baidu.openrasp.hook.molice.DetectAuthorityVunlClass()).detect(request, currentSql);" +
                                "if (resultStr.equals(\"1\")){int len = pack.getPayloadLength();byte[] b = new byte[len];byte[] c = pack.getByteBuffer();" +
                                "if (c[1] == 85) {b[1] = 115;pack.setByteBuffer( b );}}}"
                );
                // è¿”å›å­—èŠ‚ç ï¼Œå¹¶ä¸”detachCtClasså¯¹è±¡
                byte[] byteCode = clazz.toBytecode();
                //detachçš„æ„æ€æ˜¯å°†å†…å­˜ä¸­æ›¾ç»è¢«javassiståŠ è½½è¿‡çš„Dateå¯¹è±¡ç§»é™¤ï¼Œå¦‚æœä¸‹æ¬¡æœ‰éœ€è¦åœ¨å†…å­˜ä¸­æ‰¾ä¸åˆ°ä¼šé‡æ–°èµ°javassiståŠ è½½
                clazz.detach();
                return byteCode;
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
        // å¦‚æœè¿”å›nullåˆ™å­—èŠ‚ç ä¸ä¼šè¢«ä¿®æ”¹
        return null;
    }


}
```

> DetectAuthorityVunlClassç±»

```
package com.baidu.openrasp.hook.molice;

import com.baidu.openrasp.hook.InsertRedis.SelectInfoFromRedis;
import com.baidu.openrasp.hook.InsertRedis.InsertInfoToRedis;
import com.baidu.openrasp.request.AbstractRequest;

/**
 * Description
 * <p>
 * </p>
 * DATE 2020/4/18.
 *
 * @author molice.
 */
public class DetectAuthorityVunlClass {
    public String detect(AbstractRequest request, String bytes) {

        String currentSql = hexStr2Str( bytes );
        String ua = request.getHeader( "user-agent" );
        //è®°å½•å½“å‰requestIdæ£€æµ‹æ£€æµ‹çš„sqlåç§»
        InsertInfoToRedis insertInfoToRedis = new InsertInfoToRedis();
        // é¦–å…ˆåˆ¤æ–­è¯·æ±‚æ˜¯å¦æ¥è‡ªæ‰«æå™¨
        if (ua.contains( "TestBySecurityTeamForVunl" )) {
            System.out.println( "åŒ¹é…åˆ°äº†å‘èµ·çš„æ£€æµ‹è¯·æ±‚ï¼Œå¼€å§‹æ‰§è¡Œè¶Šæƒåˆ¤æ–­çš„é€»è¾‘" );
            //è®°å½•å½“å‰requestIdæ£€æµ‹æ£€æµ‹çš„sqlåç§»
            insertInfoToRedis.setSqlCount( request.getRequestId() );

            String[] uaSplited = ua.split( "-" );
            String origRequestid = uaSplited[1];
            // æ ¹æ®æ‰§è¡Œçš„sqlè¯­å¥æ˜¯å¦ä¸€è‡´å­˜åœ¨æ¼æ´
            com.baidu.openrasp.hook.InsertRedis.SelectInfoFromRedis getInfoFromRedis = new com.baidu.openrasp.hook.InsertRedis.SelectInfoFromRedis();
            int sqlIndex = insertInfoToRedis.getSqlCount( request.getRequestId() ) - 1;
            System.out.println( "index:" + sqlIndex );
            if (sqlIndex < 0) {
                sqlIndex = 1;
            }
            String oriGSql = getInfoFromRedis.getSqlString( origRequestid, sqlIndex );

            if (currentSql.equals( oriGSql )) {
                String url = getInfoFromRedis.getUrl( origRequestid );
                System.out.println( "æ£€æµ‹åˆ°æ›¿æ¢èº«ä»½ä¿¡æ¯ä»¥åæ‰§è¡Œäº†ç›¸åŒçš„SQLè¯­å¥,urlï¼š " + url );
                System.out.println( "   origSql:" + oriGSql );
                System.out.println( "currentSql:" + currentSql );
            } else {
                String url = getInfoFromRedis.getUrl( origRequestid );
                System.out.println( "æ£€æµ‹åˆ°æ›¿æ¢èº«ä»½ä¿¡æ¯ä»¥åæ‰§è¡Œäº†ä¸åŒçš„SQLè¯­å¥,urlï¼š " + url );
                System.out.println( "   origSql:" + oriGSql );
                System.out.println( "currentSql:" + currentSql );
            }
            return "1";
        } else {
            //æ­£å¸¸è¯·æ±‚åˆ™ä»…è®°å½•å‘é€çš„packet" +
            String requestId = request.getRequestId();
            (new com.baidu.openrasp.hook.InsertRedis.InsertInfoToRedis()).InsertToList( requestId + ":sql", currentSql );
            return "0";
        }
    }

    public static String hexStr2Str(String hexStr) {
        String s = "";
        for (String s1 : hexStr.split( "\n" )) {
            s = s + s1.substring( 0, 24 );
        }
        String str = "0123456789abcdef";
        char[] hexs = s.replace( " ", "" ).toCharArray();
        byte[] bytes = new byte[s.replace( " ", "" ).length() / 2];
        int n;
        for (int i = 0; i < bytes.length; i++) {
            n = str.indexOf( hexs[2 * i] ) * 16;
            n += str.indexOf( hexs[2 * i + 1] );
            bytes[i] = (byte) (n & 0xff);
        }
        return new String( bytes );
    }
}

```

> EngineBoot.javaçš„initTransformeræ–¹æ³•ä¸­æ’å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„å­—èŠ‚ç è½¬æ¢å™¨ç±»

```
private void initTransformer(Instrumentation inst) throws UnmodifiableClassException {
        inst.addTransformer( new SqlTransformer2(), true );
        transformer = new CustomClassTransformer( inst );
        transformer.retransform();
    }
```

ç„¶ååœ¨ **openrasp-master/agent/java** ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯¹ **agent** é‡æ–°ç¼–è¯‘æ‰“åŒ…ï¼Œ

> mvn clean package

é‡æ–°å¯åŠ¨é¡¹ç›®å‘ç°æˆ‘ä»¬å·²ç»å¯ä»¥è·å–åˆ°RequestIdå’Œsqlå¯¹åº”çš„ä¿¡æ¯äº†
![](./images/5.png)


## 0x4 demo

ä»¥ä¸‹æ˜¯æˆ‘åœ¨æœ¬åœ°demoä¸­æµ‹è¯•çš„æµç¨‹
![](./images/1.jpg)

```
POST /rest/parentrest/api/pc/address/update HTTP/1.1
Host: 127.0.0.1:8001
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 268
Origin: http://127.0.0.1:8001
Connection: keep-alive
Referer: http://127.0.0.1:8001/student/setting
Cookie: "Aè´¦å·çš„cookie"

customerName=%E5%8F%B6%E9%97%AE&customerMobile=15166667775&province=%E5%8C%97%E4%BA%AC&city=%E5%8C%97%E4%BA%AC%E5%B8%82&district=%E4%B8%9C%E5%9F%8E%E5%8C%BA&address=%E5%A4%A7%E6%82%A6%E5%9F%8E21s%26amp%3Bamp%3Bamp%3Bamp%3Ba&zipcode=290122&isDefault=1&id=21618
```
![](./images/10.png)

> ç‚¹å‡»ä¿å­˜æ”¶è´§åœ°å€ï¼Œæ­¤æ—¶å·²ç»è®°å½•äº†æ‰§è¡Œçš„sqlè¯­å¥,è®°å½•åˆ°çš„requestId ä¸º **4582ed3194ad43c38ff613a817bf6b4b**

![](./images/12.png)

> æ›¿æ¢èº«ä»½ä½¿ç”¨pythoné‡æ–°å‘èµ·è¯·æ±‚

```
POST /rest/parentrest/api/pc/address/update HTTP/1.1
Host: 127.0.0.1:8001
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 268
Origin: http://127.0.0.1:8001
Connection: keep-alive
Referer: http://127.0.0.1:8001/student/setting
Cookie: "Bè´¦å·çš„cookie"

customerName=%E5%8F%B6%E9%97%AE&customerMobile=15166667775&province=%E5%8C%97%E4%BA%AC&city=%E5%8C%97%E4%BA%AC%E5%B8%82&district=%E4%B8%9C%E5%9F%8E%E5%8C%BA&address=%E5%A4%A7%E6%82%A6%E5%9F%8E21s%26amp%3Bamp%3Bamp%3Bamp%3Ba&zipcode=290122&isDefault=1&id=21618
```

>main.py æ¨¡æ‹Ÿå‘èµ·è¯·æ±‚çš„python3ç¨‹åº

```
import time
import requests
import json
import redis

r = redis.Redis(host='127.0.0.1', port=6379, db=4)


def getRequestInfoFromRedis(orginRequestId, newCookie):
    headers = {}
    # è·å–åŸå§‹headers
    headerInfo = r.hgetall(orginRequestId + ':headers')
    for key in headerInfo.keys():
        headers[key.decode()] = headerInfo.get(key).decode()

    # æ›¿æ¢cookie(ç”Ÿäº§ä¸­å¾ˆå¤šè®¤è¯ä¸æ˜¯ä»cookieä¸­å–çš„èº«ä»½ä¿¡æ¯)
    newHeaders = headers.copy()
    newHeaders['cookie'] = newCookie
    newHeaders["user-agent"] = headers['user-agent'] + 'TestBySecurityTeamForVunl-' + orginRequestId
    newHeaders.pop('content-length')

    # ç”Ÿæˆdata
    data = {}
    params = r.hgetall(orginRequestId + ':params')
    for key in params.keys():
        data[key.decode()] = params.get(key).decode()

    # è·å–url
    url = r.get(orginRequestId + ':url').decode()

    # è·å–request method
    method = r.get(orginRequestId + ':method').decode()

    if method.startswith('P'):
        res = requests.post(url=url, headers=newHeaders, data=data)
        resRequestId = res.headers.get('X-Request-ID')
        print('åŸå§‹è¯·æ±‚ requestId: %s:  sqlè¯­å¥ï¼š%s' % (
            orginRequestId, r.lindex(orginRequestId + ':sql', 0)))
        print('æ£€æµ‹è¯·æ±‚ requestId: %s:  sqlè¯­å¥ï¼š%s' % (
            resRequestId, r.lindex(resRequestId + ':sql', 0)))


if __name__ == '__main__':
	 # 1ã€é¦–å…ˆçœ‹ä¸‹æ”¶åˆ°çš„sqlè¯­å¥
	 """
	 UPDATE `address` SET `name`='\xE5\x8F\xB6\xE9\x97\xAE',`mobile`='15166667775',`province`='\xE5\x8C\x97\xE4\xBA\xAC',`city`='\xE5\x8C\x97\xE4\xBA\xAC\xE5\xB8\x82',`district`='\xE4\xB8\x9C\xE5\x9F\x8E\xE5\x8C\xBA',`address`='\xE5\xA4\xA7\xE6\x82\xA6\xE5\x9F\x8E22s',`zipcode`=290122,`isDefault`=1 WHERE `id` = 21618
	 """
    # 2ã€ä¸ºäº†æ¼”ç¤ºä¸ä¼šäº§ç”Ÿè„æ•°æ®æˆ‘ä»¬æå‰æŠŠåº“ä¸­è°åšä¸€ä¸‹ä¿®æ”¹
    # 3ã€ä¸‹é¢æˆ‘ä»¬å‘èµ·æ£€æµ‹è¯·æ±‚è§‚å¯Ÿæ˜¯å¦ä¼šæ‹¦æˆªåˆ°sqlè¯­å¥ä»¥åŠæ˜¯å¦ä¼šå¯¹åŸæ¥æ•°æ®äº§ç”Ÿå½±å“
    # 4ã€å¯ä»¥çœ‹åˆ°å³æ£€æµ‹äº†è¶Šæƒ åˆä¸ä¼šäº§ç”Ÿè„æ•°æ®
	
	
	 // éœ€è¦è¢«æ£€æµ‹çš„è¯·æ±‚çš„ç¼–å· ä¹Ÿå°±æ˜¯åˆšæ‰è®°å½•åˆ°çš„requestId
	 orginRequestId = '4582ed3194ad43c38ff613a817bf6b4b'
	 newCookie = 'è´¦å·Bçš„cookie'
    getRequestInfoFromRedis(orginRequestId= orginRequestId,
                            newCookie= newCookie)

```

> æ‰§è¡Œä»¥åå¯ä»¥çœ‹åˆ°è¾“å‡ºä¿¡æ¯

![](./images/13.gif)
å¯ä»¥å‘ç°æ›¿æ¢èº«ä»½ä»¥åæ‰§è¡Œçš„ sql è¯­å¥æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­WHEREæ¡ä»¶ä¸­çš„å­—æ®µ **id** å­˜åœ¨è¶Šæƒæ¼æ´ï¼ŒåŒæ—¶åœ¨æ•°æ®åº“ä¸­å¹¶ä¸ä¼šäº§ç”Ÿè„æ•°æ®ï¼Œæ­¤å¤„æ¼”ç¤ºçš„æ˜¯Updateç±»å‹çš„æ‹¦æˆªï¼Œå¦‚æœæƒ³é’ˆå¯¹selectä¹Ÿè¿›è¡Œæ‹¦æˆªå¯ä»¥å°†æ‹¦æˆªæ¡ä»¶é…ç½®åŒ–ï¼ŒåæœŸéœ€è¦ä¼˜åŒ–çš„ç»†èŠ‚è¿˜æœ‰å¾ˆå¤šã€‚


## 0x5 å¦‚ä½•æ›´å¥½
1ã€**è¯¯æŠ¥** 

> é€šè¿‡ä»¥ä¸Šçš„æ¡ˆä¾‹å¯ä»¥å‘ç°é€šè¿‡åˆ¤æ–­å’Œæ•°æ®åº“å±‚çš„äº¤äº’ä¿¡æ¯åŸºæœ¬å¯ä»¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¶Šæƒï¼Œè€Œä¸”æˆ‘ä»¬æ£€æµ‹çš„éƒ½æ˜¯å¯ä»¥æ‹¦æˆªåˆ°æ‰§è¡Œäº†sqlè¯­å¥çš„è¯·æ±‚ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šä¸ä¼šå­˜åœ¨è¯¯æŠ¥é—®é¢˜

2ã€ **æ¼æŠ¥**
  
> 1. ç”±äºåœ¨ç”Ÿäº§ä¸­æ•°æ®åº“ç±»å‹ã€ç‰ˆæœ¬åˆ†å¸ƒæ¯”è¾ƒä¼šå­˜åœ¨å…¼å®¹é—®é¢˜ï¼Œè¿™éƒ¨åˆ†ç›®å‰çœ‹åªèƒ½åç»­å®Œå–„çš„å¯¹mysqlã€oracleç­‰ä¸»æµæ•°æ®åº“çš„æ£€æµ‹
> 2. å¦ä¸€ä¸ªæ–¹é¢æ˜¯æˆ‘çš„åŒäº‹èƒœå“¥æå‡ºæ¥çš„ï¼Œå¾ˆå¤šæ—¶å€™æ›´æ–°ç”¨æˆ·æ•°æ®ä¼šå…ˆå°†æ•°æ®å†™å…¥é˜Ÿåˆ—ç„¶åä»é˜Ÿåˆ—å¼‚æ­¥å†™å…¥æ•°æ®åº“ï¼Œç›®å‰è¿™ç§ç±»å‹æš‚æ—¶æ²¡æ— æ³•è§£å†³ï¼ŒåæœŸè€ƒè™‘é€šè¿‡å…¶ä»–æ€è·¯è§£å†³

3ã€**æµé‡è·å–** 

> ç›®å‰æµé‡æ˜¯é€šè¿‡openraspçš„agentè·å–çš„ï¼ŒåŒæ ·éœ€è¦è€ƒè™‘å…¼å®¹ä¸åŒçš„å®¹å™¨é—®é¢˜ï¼Œè¿™å—åæœŸå¯ä»¥è€ƒè™‘é€šè¿‡æ”¶é›†æœåŠ¡å™¨æµé‡æ’é™¤agentå…¼å®¹å„ç§webå®¹å™¨çš„é—®é¢˜ï¼Œä»è€Œå¯ä»¥ä¿è¯æ”¶é›†çš„httpä¿¡æ¯æ˜¯ä¸å­˜åœ¨é—æ¼çš„

4ã€**åˆ¤å®šæ¡ä»¶**

> ç›®å‰åˆ¤å®šsqlæ˜¯å¦ä¸€è‡´ç›´æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œæœ‰äº›åœºæ™¯ä¸‹sqlè¯­å¥ä¸­å¯èƒ½ä¼šåµŒå…¥æ—¶é—´æˆ³ç­‰å¤šå˜çš„å‚æ•°ï¼ŒåæœŸä¼˜åŒ–å…ˆä»whereéƒ¨åˆ†è¿›è¡Œæˆªæ–­ç„¶åè¿›è¡Œä¸€è‡´æ€§åŒ¹é…

5ã€**çŸ¥è¯†å…±äº«**

> çŸ¥è¯†åœ¨äºåˆ†äº«ï¼Œå¦‚æœä½ ä¹Ÿæœ‰ä¸€æ ·çš„æƒ³æ³•æ¬¢è¿ç•™è¨€æˆ–è€…æ·»åŠ æˆ‘çš„å¾®ä¿¡md5:1314285EBEEA18E2ä¸€èµ·è®¨è®ºå­¦ä¹ 


## 0x6 å¼•ç”¨&è‡´è°¢

> é¦–å…ˆæ„Ÿè°¢å¼•ç”¨ä¸­å„ä½å¤§ä½¬å’Œå›¢é˜Ÿçš„äº§å‡ºå’Œåˆ†äº«ç²¾ç¥
> å†æ¬¡æ„Ÿè°¢å›¢é˜Ÿå°ä¼™ä¼´ä¸€èµ·ç§¯æè®¨è®ºäº¤æµ

> å…¶æ¬¡ä½œä¸ºä¸€ä¸ªå•çº¯çš„èœé¸¡æŠ€æœ¯å®…æˆ‘ç›¸ä¿¡æŠ€æœ¯åªæœ‰é€šè¿‡åˆ†äº«å’Œäº¤æµæ‰ä¼šå˜å¾—æ›´å¥½ï¼Œå¦‚æœæ–‡ä¸­æœ‰æè¿°ä¸æ­£ç¡®çš„åœ°æ–¹è¾›è‹¦å¤§ä½¬æ–§æ­£

1. [baidu/openrasp: ğŸ”¥Open source RASP solution](https://github.com/baidu/openrasp)
2. [OpenRASP å®˜æ–¹æ–‡æ¡£](https://rasp.baidu.com/doc/)
* [JVMTI å’Œ Agent å®ç°](https://www.ibm.com/developerworks/cn/java/j-lo-jpda2/index.html?ca=drs-)
* [Instrumentation æ–°åŠŸèƒ½](https://www.ibm.com/developerworks/cn/java/j-lo-jse61/)
* [Java Instrumentation](https://www.cnblogs.com/yelao/p/9841810.html)
* [JVM æºç åˆ†æä¹‹ javaagent åŸç†å®Œå…¨è§£è¯»](https://www.infoq.cn/article/javaagent-illustrated)
* [Java è°ƒå¼ã€çƒ­éƒ¨ç½²ã€JVM èƒŒåçš„æ”¯æŒè€… Java Agent](https://www.cnblogs.com/fengzheng/p/11502963.html)
* [javassistä½¿ç”¨å…¨è§£æ](https://www.cnblogs.com/rickiyang/p/11336268.html)

